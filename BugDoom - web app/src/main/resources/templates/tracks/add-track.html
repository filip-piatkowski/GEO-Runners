<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorate="~{fragments/main_view}">
<head>
    <meta charset="UTF-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
        crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
          integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
          crossorigin=""></script>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <title>New track</title>
  <style>#map { height: 400px; }</style>
</head>
<body>
<div layout:fragment ="content" class="container text-left">
  <h1 >Nowa trasa</h1>
  <form th:action="@{/tracks}" th:object="${track}" method="post">
    <div style="margin-top: 5px">
    <p>Nazwa biegu: <input type="text" placeholder="Nazwa nowego biegu" th:field="*{competitionName}"/></p>
    </div>
    <p>Szerokość geograficzna startu: <input type="number" min="49" max="54.5" placeholder="54.35" step="0.001" th:field="*{start.latitude}"/></p>
    <p>Długość geograficzna startu: <input type="number" min="14.07" max="24.09" placeholder="18.65" step="0.001" th:field="*{start.longitude}"/></p>
    <p>Szerokość geograficzna mety: <input type="number" min="49" max="54.5" placeholder="54.35" step="0.001" th:field="*{finish.latitude}"/></p>
    <p>Długość geograficzna mety: <input type="number" min="14.07" max="24.09" placeholder="18.65" step="0.001" th:field="*{finish.longitude}"/></p>
    <div style="margin-top: 5px" >Poziom trudności:
      <input type="radio" id="difficultyChoice1" name="difficulty" value="łatwy"/>
      <label for="terrainChoice1">łatwy</label>
      <input type="radio" id="difficultyChoice2" name="difficulty" value="średni"/>
      <label for="terrainChoice2">średni</label>
      <input type="radio" id="difficultyChoice3" name="difficulty" value="trudny" th:field="*{difficulty}"/>
      <label for="terrainChoice3">trudny</label>
    </div>
    <p>Dystans (km): <input id="length_input" type="range" min="2" max="20" step="1" th:field="*{length}"/>
      <output id="value"></output>
    </p>
    <div style="margin-top: 5px"> Lokalizacja: <input type="radio" id="terrainChoice1" name="terrain" value="miejski"/>
      <label for="terrainChoice1">miejski</label>
      <input type="radio" id="terrainChoice2" name="terrain" value="leśny"/>
      <label for="terrainChoice2">leśny</label>
      <input type="radio" id="terrainChoice3" name="terrain" value="górzysty" th:field="*{terrain}"/>
      <label for="terrainChoice3">górzysty</label>
    </div>
    <div>
      <label for="event">Wydarzenie: </label>
      <select id="event" class="form-control" name="event.eventId">
        <option value="-1" th:text="#{track.select-event}"></option>
        <option th:each="event : ${allEvents}"
                th:value="${event.eventId}"
                th:text="${event.eventName}"></option>
      </select>
    </div>
    <div id="map" class="container"></div>
    <div>
      <table id="data-table" class="table">
        <thead>
        <th class="col-1">Szerokość</th>
        <th class="col-3">Długość</th>
        <th class="col-3">Checkpoint nr</th>
    <tr th:each="checkpoints, iterStat: ${track.checkpoints}">
      <td th:value="${checkpoints.latitude}" ></td>
      <td th:value="${checkpoints.longitude}"></td>
      <td th:text="${checkpoints.locationName}"></td>
    </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

    <ul th:if="${#fields.hasErrors('*')}">
      <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
    </ul>
    <p><input class="btn btn-success" type="submit" value="Zatwierdź"/>
      <input class="btn btn-secondary" type="reset" value="Zresetuj"/></p>
  </form>

  <script th:inline="javascript">

    function updateDataTable (map) {
      let dataTableBody = $('#data-table tbody')
      dataTableBody.html('<tr></tr>')
      map.eachLayer(layer => {
        let popup = layer.getPopup()
        if (popup) {
          let text = $(popup.getContent()).find('.popup-span').text()
          let latLng = layer.getLatLng()
          dataTableBody.append(
                  $('<tr></tr>').append(
                          $('<td></td>').text(latLng.lat),
                          $('<td></td>').text(latLng.lng),
                          $('<td></td>').text(text),
                  )
          )
        }
      })
    }

    function createPopupContents(marker) {
      let popupContents = $('<div></div>')
      popupContents.append(
              $('<span></span>').addClass('popup-span').text('Checkpoint')
      )


      let trashButton = $('<button><i class="fas fa-trash" />Usuń</button>')
              .on('click', event => {
                marker.remove()
                updateDataTable(map)
              })

      popupContents.append(trashButton)
      return popupContents[0]
    }

    var options = {center: [54.349, 18.651],zoom: 12}
    var map = L.map('map', options);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let popupOpen = null
    map.on('preclick', mapEvent => {
      popupOpen = false
      map.eachLayer(layer => {
        if (layer.getPopup() && layer.getPopup().isOpen()) {
          popupOpen = true
        }
      })
    })

    map.on('click', mapEvent => {
      if (!popupOpen) {
        let marker = L.marker(mapEvent.latlng)
        marker.addTo(map).bindPopup(createPopupContents(marker));
        updateDataTable(map)
      }
    })
    updateDataTable(map)

  </script>
  <script>
    const value = document.querySelector("#value")
    const input = document.querySelector("#length_input")
    value.textContent = input.value
    input.addEventListener("input", (event) => {
      value.textContent = event.target.value
    })
  </script>
  <a href="/tracks" class="btn btn-primary"><i class="fas fa-angle-double-left"></i> Powrót do listy tras</a>
</div>

</body>
</html>